mod.ScaledEnemySets = {
    F = {
        "BiomeF",
    },
    G = {
        "BiomeG",
        "CocoonSpawnsEasy_G",
    },
    H = {
        "BiomeH",
        "BiomeHPassive",
        "BiomeHDebugSpawnScreen",
    },
    I = {
        "BiomeI",
    },
    N = {
        "BiomeN",
    },
    O = {
        "BiomeO",
        "BiomeOIntro",
    },
    P = {
        "BiomeP",
        "BiomePIntro",
    },
    Q = {
        "BiomeQ",
        "TyphonEggSpawnOptions",
    },
    Tartarus = {
        "EnemiesBiome1",
        "EnemiesBiome1MiniBoss"
    },
    Asphodel = {
        "EnemiesBiome2",
    },
    Elysium = {
        "EnemiesBiome3",
    },
    Styx = {
        "EnemiesBiome4",
        "EnemiesBiome4MiniBoss",
        "EnemiesHadesLarge",
        "EnemiesHadesSmall",
        "EnemiesHadesEMLarge",
        "EnemiesHadesEMSmall",
    }
}

mod.ScaledMiniBosses = {
    F = {
        "ZombieAssassin_Miniboss",
        "ZombieAssassin_Shadow",

        "Treant",
        "TreantTail",
        "TreantTail_Shadow",
        "Treant_Shadow",

        "FogEmitter_Elite",
        "FogEmitter_Shadow",
        "Screamer_Shadow",
    },
    G = {
        "WaterUnitMiniboss",
        "WaterUnitMiniboss_Shadow",

        "Octofish_Miniboss",
        "Octofish_Shadow",
        "Jellyfish",

        "CrawlerMiniboss",
        "Crawler_Shadow",
        "ThiefMineLayer_Elite",
    },
    H = {
        "Vampire",
        "Mourner_Shadow",

        "Treant2",
        "TreantTail2",

        "Lamia_Miniboss",
        "Lovesick_Shadow",
        "Lamia_Support",
    },
    I = {
        "SatyrRatCatcher_Miniboss",
        "SatyrLancer_Shadow",
        "Crawler",

        "GoldElemental_MiniBoss",
        "GoldElemental_Shadow",
    },
    N = {
        "SatyrCrossbow",
        "SatyrCrossbow_Shadow",

        "Boar",
        "Boar_Shadow",

        "MudmanEye",
        "Zombie_Passive"
    },
    O = {
        "Charybdis",
        "CharybdisTentacle",
        "Swab_Shadow",

        "Captain",
        "Captain_Shadow",
    },
    P = {
        "Talos",
        "AutomatonBeamer_Shadow",
        "AutomatonEnforcer_Shadow",

        "Dragon_MiniBoss",
        "Dragon_Shadow",
    },
    Q = {
        "TyphonEye",
        "Eyeball",
        "Mudman_Shadow",
        "MudmanEye_Elite",

        "TyphonTail",
        "TyphonTailMine",
        "DragonBurrower_Shadow",

        "Brute_Miniboss",
        "Brute_Shadow",

        "EarthElemental",
        "EarthElemental_Shadow",
        "Stalker_Miniboss",
    },
    Tartarus = {
        "WretchAssassin",
        "WretchAssassinMiniboss",
        "HeavyRangedSplitterMiniboss",
        "HeavyRangedSplitterFragment",
    },
    Asphodel = {
        "ShieldRangedMiniBoss",
        "SpreadShotUnitMiniboss",
        "HitAndRunUnit",
        "CrusherUnitElite"
    },
    Elysium = {
        "FlurrySpawnerElite",

        "ShadeNaked",
    },
    Styx = {
        "SatyrRangedMiniboss",
        "RatThugMiniboss",
        "HeavyRangedForkedMiniboss",
        "ThiefImpulseMineLayerMiniboss",
        "HadesCrawlerMiniBoss"
    }
}

mod.ScaledBosses = {
    F = {
        "Hecate",
        "HecateCopy",
        "HecateCopyEM",
    },
    G = {
        "Scylla",
        "SirenDrummer",
        "SirenKeytarist",
        "Charybdis_ScyllaFight",
        "CharybdisTentacle2",
        "FloodTrap",
        "Jellyfish_Scylla",
    },
    H = {
        "InfestedCerberus",
    },
    I = {
        "Chronos",
        "Chronos_EMShadow",

        "TimeElemental2",
        "TimeElemental2_EM",
        "SatyrCultist",
        "SatyrCultist_Elite",
        "Screamer2_SuperElite",
        "Treant2_SuperElite",
        "Octofish_SuperElite",
        "Vampire_SuperElite",
        "Lamia_SuperElite",
        "ClockworkHeavyMelee_SuperElite",
        "SatyrRatCatcher_SuperElite",
    },
    N = {
        "Polyphemus",
        "Medea",
        "ZombieHeavyRanged_EM",
    },
    O = {
        "Eris",
        "GunBombUnit",
    },
    P = {
        "Prometheus",
        "Eagle",
        "Heracles",
    },
    Q = {
        "TyphonHead",
        "TyphonHeadAdd",
        "TyphonHeadStaggeredDummy",
        "TyphonTail_Incursion",
        "TyphonArm",
        "TyphonArm_Incursion",

        "TyphonHeadEgg01",
        "TyphonHeadEgg02",
        "TyphonHeadEgg03",
        "TyphonHeadEgg04",
        "TyphonHeadEgg05",
        "TyphonHeadEggCaptain",
        "TyphonHeadEggBoar",
        "TyphonHeadEggDragon",

        "Simple2",
        "Brute2",
        "Mudman2",
        "LycanSwarmer2",
        "FishmanMelee2",
        "Captain_SuperElite",
        "Boar_SuperElite",
        "Dragon_SuperElite",

        "Chronos_TyphonFight",
    },
    Tartarus = {
        "HarpySupportUnit",
        "Harpy",
        "Harpy2",
        "Harpy3",
    },
    Asphodel = {
        "HydraHeadImmortal",
        "HydraHeadImmortalLavamaker",
        "HydraHeadImmortalSummoner",
        "HydraHeadImmortalSlammer",
        "HydraHeadImmortalWavemaker",
        "HydraHeadDartmaker",
        "HydraHeadLavamaker",
        "HydraHeadSummoner",
        "HydraHeadSlammer",
        "HydraHeadWavemaker",
        "HydraTooth",
        "HydraTooth2",
    },
    Elysium = {
        "Theseus",
        "Theseus2",
        "Minotaur",
        "Minotaur2",
    },
    Styx = {
        "Hades",
        "CerberusAssistUnit",
    }
}

mod.EnemyBiomeMap = {}

for biome, enemySets in pairs(mod.ScaledEnemySets) do
    for _, enemySet in ipairs(enemySets) do
        if game.EnemySets[enemySet] then
            for _, enemy in ipairs(game.EnemySets[enemySet]) do
                mod.EnemyBiomeMap[enemy] = biome
            end
        end
    end
end

for biome, enemies in pairs(mod.ScaledMiniBosses) do
    for _, enemy in ipairs(enemies) do
        mod.EnemyBiomeMap[enemy] = biome
    end
end

for biome, enemies in pairs(mod.ScaledBosses) do
    for _, enemy in ipairs(enemies) do
        mod.EnemyBiomeMap[enemy] = biome
    end
end

function mod.IsUnitMenace(currentBiome, attackerBiome)
    local biomeData = mod.BiomeData[currentBiome] or {}
    local next = biomeData.Next
    return next ~= nil and next == attackerBiome
end

mod.DamageScaling = {
    1.0,
    1.8,
    2.5,
    3.5,
}

function mod.ScaleDamage(damage, attackerBiome)
    local currentDepth = game.CurrentRun.ClearedBiomes
    local biomeDepth = (mod.BiomeData[attackerBiome] or {}).Position or currentDepth
    local newDamage = damage * (mod.DamageScaling[currentDepth] / mod.DamageScaling[biomeDepth])
    return newDamage
end

modutil.mod.Path.Wrap("Damage", function (base, victim, triggerArgs)
    if victim == game.CurrentRun.Hero and game.Contains(mod.RegisteredBounties, game.CurrentRun.ActiveBounty) and config.scaling then
        local attacker = (triggerArgs or {}).AttackerTable or {}
        local route = game.CurrentRun[_PLUGIN.guid .. "GeneratedRoute"] or {}
        local currentBiome = route[game.CurrentRun.ClearedBiomes]
        if currentBiome and mod.EnemyBiomeMap[attacker.Name or "Unknown"] then
            local attackerName = attacker.Name or "Unknown"
            local attackerBiome = mod.EnemyBiomeMap[attackerName]
            print("Attacker name:", attackerName)
            print("Attacker biome:", mod.EnemyBiomeMap[attacker.Name])
            if mod.IsUnitMenace(currentBiome, attackerBiome) then
                attackerBiome = currentBiome
            end
            if attackerBiome and currentBiome and
                    triggerArgs.DamageAmount ~= nil and triggerArgs.DamageAmount > 0 then
                print("Incoming damage:", triggerArgs.DamageAmount)
                triggerArgs.DamageAmount =  mod.ScaleDamage(triggerArgs.DamageAmount, attackerBiome)
                print("Scaled damage:", triggerArgs.DamageAmount)
            end
        else
            print("Attacker name:", attacker.Name)
            print("Attacker biome not found")
        end
    end
    return base(victim, triggerArgs)
end)

modutil.mod.Path.Wrap("SetupUnit", function (base, unit, currentRun, args)
    base(unit, currentRun, args)
    if game.Contains(mod.RegisteredBounties, game.CurrentRun.ActiveBounty) and config.scaling then
        local route = game.CurrentRun[_PLUGIN.guid .. "GeneratedRoute"] or {}
        local currentBiome = route[game.CurrentRun.ClearedBiomes]
        if currentBiome and mod.EnemyBiomeMap[unit.Name or "Unknown"] then
            local unitName = unit.Name or "Unknown"
            local unitBiome = mod.EnemyBiomeMap[unitName]
            if mod.IsUnitMenace(currentBiome, unitBiome) then
                unitBiome = currentBiome
            end
            if unitBiome and currentBiome then
                if unit.MaxHealth ~= nil then
                    print("Scaling health for:", unit.Name, unit.Health)
                    unit.MaxHealth = mod.ScaleDamage(unit.MaxHealth, unitBiome)
                    unit.Health = unit.MaxHealth
                    print("New health:", unit.Health)
                end
                if unit.HealthBuffer ~= nil and unit.HealthBuffer > 0 then
                    print("Scaling health buffer for:", unit.Name, unit.HealthBuffer)
                    unit.HealthBuffer = mod.ScaleDamage(unit.HealthBuffer, unitBiome)
                    print("new health buffer", unit.HealthBuffer)
                end
                if unit.MaxHealthBuffer ~= nil and unit.MaxHealthBuffer > 0 then
                    print("Scaling max health buffer for:", unit.Name, unit.MaxHealthBuffer)
                    unit.MaxHealthBuffer = mod.ScaleDamage(unit.MaxHealthBuffer, unitBiome)
                    print("new max health buffer", unit.MaxHealthBuffer)
                end
                if unit.AIStages ~= nil and type(unit.AIStages) == "table" then
                    for _, stage in ipairs(unit.AIStages) do
                        if stage.NewMaxHealth ~= nil then
                            stage.NewMaxHealth = mod.ScaleDamage(stage.NewMaxHealth, unitBiome)
                        end
                    end
                end
                if unit.ShrineDataOverwrites ~= nil and unit.ShrineDataOverwrites.MaxHealth ~= nil then
                    unit.ShrineDataOverwrites.MaxHealth = mod.ScaleDamage(unit.ShrineDataOverwrites.MaxHealth, unitBiome)
                end
            end
        elseif unit.MaxHealth ~= nil and unit.MaxHealth ~= 0 then
            print("Unable to scale health for:", unit.Name)
        end
    end
end)